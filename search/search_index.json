{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Synology Dynamic DNS with Cloudflare for both multidomains and subdomains","text":""},{"location":"#table-of-contents","title":"Table of contents","text":"<ul> <li>What this script does</li> <li>Before you begin</li> <li>How to install</li> <li>Troubleshooting and known issues</li> <li>CloudFlare API free domains limitation</li> <li>Connection test failed or error returned</li> <li>Cloudflare no longer listed as a DDNS provider after a DSM update</li> <li>Default Cloudflare ports</li> <li>Debug script</li> </ul>"},{"location":"#what-this-script-does","title":"What this script does","text":"<ul> <li>A PHP script for Synology DSM (and potentially Synology SRM devices) adding support for Cloudflare to Network Centre &gt; Dynamic DNS (DDNS).</li> <li>Supports single domains, multidomains, subdomains and regional domains, or any combination thereof (example: dev.my.domain.com.au, domain.com.uk etc)</li> <li>Easy instalation process</li> <li>Based on CloudFlare API v4</li> <li>Supports dual stack IPv4 and IPv6</li> </ul>"},{"location":"#before-you-begin","title":"Before you begin","text":"<p>Before starting the installation process, make sure you have (and know) the following information, or have completed these steps:</p> <ol> <li> <p>Cloudflare credentials:</p> <p>a. Know your Cloudflare account username (or register for an account if you're new to Cloudflare); and</p> <p>b. Have your API key - no need to use your Global API key! (More info: API keys).</p> <p></p> <p>c. Create a API key with following (3) permissions:</p> <p>Zone &gt; Zone.Settings &gt; Read Zone &gt; Zone &gt; Read Zone &gt; DNS &gt; Edit </p> <p>The affected zone ressouces have to be (at least):</p> <p>Include &gt; All zones from an account &gt; <code>&lt;domain&gt;</code> </p> </li> <li> <p>DNS settings:</p> <p>Ensure the DNS A record(s) for the domain/zone(s) you wish to update with this script have been created (More information: Managing DNS records).</p> <p>Your DNS records should appear (or already be setup as follows) in Cloudflare:</p> <p>(Note: Having Proxied turned on for your A records isn't necessary, but it will prevent those snooping around from easily finding out your current IP address)</p> <p></p> </li> <li> <p>SSH access to your Synology device:</p> </li> </ol> <p>If you haven't setup this access, see the following Synology Knowledge Base article: [How can I sign in to DSM/SRM with root privilege via SSH?[(https://kb.synology.com/en-id/DSM/tutorial/How_to_login_to_DSM_with_root_permission_via_SSH_Telnet)</p> <ol> <li>SRM users: Knowledge of vi:</li> </ol> <p>vi is the only text editor available within the Busybox environment available at the SSH command line on devices running SRM.</p> <p>For assistance with vi commands, see: Basic vi commands</p>"},{"location":"#how-to-install","title":"How to install","text":"<ol> <li> <p>SSH with root privledges on your supported device:</p> <p>a. For DSM Users:</p> <p>Navigate to Control Panel &gt; Terminal &amp; SNMP &gt; Enable SSH service</p> <p>b. For SRM users:</p> <p>Navigate to Control Panel &gt; Services &gt; System Services &gt; Terminal &gt; Enable SSH service</p> <p></p> </li> <li> <p>Connect via SSH: Connect to your supported device via SSH and execute command</p> </li> <li> <p>For DSM Users   <code>wget https://raw.githubusercontent.com/mrikirill/SynologyDDNSCloudflareMultidomain/master/cloudflare.php -O /usr/syno/bin/ddns/cloudflare.php &amp;&amp; sudo chmod 755 /usr/syno/bin/ddns/cloudflare.php</code></p> </li> <li> <p>For SRM Users   Note: Ensure you are connected as root in your SSH session   <code>wget https://raw.githubusercontent.com/mrikirill/SynologyDDNSCloudflareMultidomain/master/cloudflare.php -O /usr/syno/bin/ddns/cloudflare.php &amp;&amp; chmod 755 /usr/syno/bin/ddns/cloudflare.php</code></p> <p>Note: For SRM users, you must connect to your device as root. No other username will allow these commands to run.</p> </li> <li> <p>Update DDNS provider list: Using a command line editor, insert the text below to your DMS file (Location : /etc.defaults/ddns_provider.conf), to add DDNS support via Cloudflare:</p> <p><code>[Cloudflare]   modulepath=/usr/syno/bin/ddns/cloudflare.php   queryurl=https://www.cloudflare.com/</code></p> <p>Note: For SRM users, break out this Vim cheat sheet, as it's the only text editor available to you.</p> </li> <li> <p>Update your DDNS settings: </p> <p>a. For DSM Users: Navigate to Control Panel &gt; External Access &gt; DDNS then add new DDNS</p> <p>b. For SRM users: Navigate to Network Centre &gt; Internet &gt; QuickConnect &amp; DDNS &gt; DDNS and press the Add button:</p> <p>Add/Update the DDNS settings screen as follows:</p> <ul> <li>Service provider: Select Cloudflare</li> <li> <p>Hostname:  For a single domain: mydomain.com For multiple domains: subdomain.mydomain.com---vpn.mydomain.com (ensure each domain is seperated by three dashes: ---)</p> <p>Note: there is 128 symbols limit on Hostname input     * Username: The email address you use for logging in to Cloudflare (optional since the API key is sufficient)     * Password: Your created Cloudflare API Key</p> </li> </ul> <p></p> <p>Finally, press the test connection button to confirm all information is correctly entered, before pressing Ok to save and confirm your details.</p> </li> <li> <p>Enjoy \ud83c\udf7a and don't forget to deactivate SSH (step 1) if you don't need it.</p> </li> </ol>"},{"location":"#troubleshooting-and-known-issues","title":"Troubleshooting and known issues","text":""},{"location":"#cloudflare-api-free-domains-limitation","title":"CloudFlare API free domains limitation","text":"<p>CloudFlare API doesn't support domains with a .cf, .ga, .gq, .ml, or .tk TLD (top-level domain)</p> <p>For more details read here: https://github.com/mrikirill/SynologyDDNSCloudflareMultidomain/issues/28 and https://community.cloudflare.com/t/unable-to-update-ddns-using-api-for-some-tlds/167228/61</p> <p>Response example:</p> <pre><code>{\n  \"result\": null,\n  \"success\": false,\n  \"errors\": [\n    {\n      \"code\": 1038,\n      \"message\": \"You cannot use this API for domains with a .cf, .ga, .gq, .ml, or .tk TLD (top-level domain). To configure the DNS settings for this domain, use the Cloudflare Dashboard.\"\n    }\n  ],\n  \"messages\": []\n}\n</code></pre>"},{"location":"#connection-test-failed-or-error-returned","title":"Connection test failed or error returned","text":"<p>This will manifest as either 1020 error; or the update attempt not showing in your Cloudflare Audit logs.</p> <p>That generally means you may not have entered something correctly in the DDNS screen for your domain(s).</p> <p>Revisit Before you begin to ensure you have all the right information, then go back to Step 4 in How to install to make sure everything is correctly entered.</p> <p>Handy hint: You can also check your Cloudflare Audit logs to see what - if anything - has made it there with your API key (More information: Understanding Cloudflare Audit Logs). Updates using the API will appear in the Audit logs as a Rec Set action.</p>"},{"location":"#cloudflare-no-longer-listed-as-a-ddns-provider-after-dsm-or-srm-updates","title":"Cloudflare no longer listed as a DDNS provider after DSM or SRM updates","text":"<p>After system updates to either Synology DSM or SRM, you may find that: * /usr/syno/bin/ddns/cloudflare.php has been deleted; * /etc.defaults/ddns_provider.conf was reset to its default settings (settings for Cloudflare no longer included); and * The DDNS settings in your DDNS panel constantly show Cloudflare's status as loading.</p> <p>If this occurs, simply repeat the How to install steps shown above.</p>"},{"location":"#default-cloudflare-ports","title":"Default Cloudflare ports","text":"<p>Source Identifying network ports compatible with Cloudflare's proxy</p> HTTP ports supported by Cloudflare HTTPS ports supported by Cloudflare 80 443 8080 2053 8880 2083 2052 2087 2082 2096 2086 8443 2095"},{"location":"#debug","title":"Debug","text":"<p>You can run this script directly to see output logs</p> <ul> <li> <p>SSH into your Synology system </p> </li> <li> <p>Run this command: </p> </li> </ul> <pre><code>/usr/bin/php -d open_basedir=/usr/syno/bin/ddns -f /usr/syno/bin/ddns/cloudflare.php \"\" \"your-CloudFlare-token\" \"your---domains---divided---by---dashes\" \"ip-address\"\n</code></pre> <ul> <li>Check output logs</li> </ul>"},{"location":"#credits","title":"Credits","text":"<p>Table of contents generated with markdown-toc DB Tech - creating API keys and using Cloudflare CNAME for single updates</p>"}]}